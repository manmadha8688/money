{% load static%}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Loan Under Review</title>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #e8f8f5, #f4f9fd);
      color: #2c3e50;
    }

    .header {
      background-color: #04c29f;
      color: white;
      padding: 20px 30px;
      border-bottom-left-radius: 40px;
      border-bottom-right-radius: 40px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .logo-wrapper {
      position: absolute;
      left: 30px;
    }
    
    .company-logo {
      width: 80px;
      height: auto;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .company-info {
      text-align: center;
    }
    
    .company-info h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 1px;
    }
    
    .company-info p {
      margin: 5px 0 0;
      font-size: 14px;
      font-style: italic;
    }
    

    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      text-align: center;
      font-size: 26px;
      margin-bottom: 20px;
    }

    .message {
      text-align: center;
      font-size: 16px;
      margin-bottom: 30px;
      color: #555;
    }

    .toggle-btn {
      background-color: #257776c6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      margin: 10px auto;
      display: inline;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-left: 20px;
    }

    .toggle-btn:hover {
      background-color: #2ba9f7;
    }

    .details-section {
      display: none;
      margin-top: 25px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 12px;
      border: 1px solid #ddd;
    }

    .details-section .row {
      display: flex;
      margin: 10px 0;
      font-size: 15px;
    }

    .label {
      min-width: 160px;
      font-weight: 600;
      color: #2c3e50;
    }

    .value {
      color: #555;
    }
    
    
  .loan-details {
      display: none;
      text-align: left;
      margin-top: 30px;
      padding: 20px 25px;
      background-color: #fefefe;
      border-radius: 10px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
      animation: slideIn 0.3s ease;
      overflow-x: auto;
  }

  .loan-details p {
      margin: 6px 0;
      font-size: 14px;
      color: #333;
  }

  .loan-details span {
      font-weight: 600;
      display: inline-block;
      width: 140px;
  }

  @keyframes fadeInUp {
      0% {
          opacity: 0;
          transform: translateY(40px);
      }
      100% {
          opacity: 1;
          transform: translateY(0);
      }
  }

  @keyframes slideIn {
      0% {
          opacity: 0;
          transform: scaleY(0.95);
      }
      100% {
          opacity: 1;
          transform: scaleY(1);
      }
  }

  @media (max-width: 600px) {
      .loan-details span {
          width: 120px;
      }
      .message-box {
          padding: 30px 20px;
      }
  }
  #payment-edit-form {
    background-color: #f9f9f9;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    max-width: 700px;
    margin: 0 auto;
    font-family: 'Segoe UI', sans-serif;
  }
  
  #payment-edit-form .row {
    display: flex;
    flex-direction: column;
    margin-bottom: 16px;
  }
  
  #payment-edit-form .label {
    margin-bottom: 6px;
    font-weight: 600;
    color: #333;
  }
  
  #payment-edit-form input[type="text"],
  #payment-edit-form select,
  #payment-edit-form input[type="file"] {
    padding: 10px 14px;
    border: 1px solid #ccc;
    border-radius: 8px;
    outline: none;
    transition: border-color 0.3s;
    font-size: 15px;
    background-color: #fff;
  }
  
  #payment-edit-form input[type="text"]:focus,
  #payment-edit-form select:focus {
    border-color: #4a90e2;
    box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
  }
  
  #payment-edit-form input[type="file"] {
    border: none;
    background-color: transparent;
    font-size: 14px;
  }
  
  #payment-edit-form button[type="submit"],
  #payment-edit-form button[type="button"] {
    background-color: #4a90e2;
    color: white;
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
    margin-right: 10px;
    transition: background-color 0.3s ease;
  }
  
  #payment-edit-form button[type="submit"]:hover,
  #payment-edit-form button[type="button"]:hover {
    background-color: #3a7bd5;
  }
  
  #payment-edit-form button[type="button"] {
    background-color: #ccc;
    color: #333;
  }
  
  #payment-edit-form button[type="button"]:hover {
    background-color: #bbb;
  }
  #payment-edit-form {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  
  #payment-edit-form.show {
    opacity: 1;
    transform: translateY(0);
  }
  .alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    padding: 10px 15px;
    border-radius: 5px;
    margin: 10px 0;
    font-weight: 500;
    text-align: center;
}

  </style>
</head>
<body>

  <div class="header">
    <div class="logo-wrapper">
      {% if loan.lender.active_user.company_logo %}
        <img src="{{ loan.lender.active_user.company_logo.url }}" alt="Company Logo" class="company-logo">
      {% else %}
        <img src="{% static 'images/default_logo.jpeg' %}" alt="Default Logo" class="company-logo">
      {% endif %}
    </div>
    <div class="company-info">
      <h1>{{ loan.lender.active_user.company_name }}</h1>
      <p>({{ loan.lender.active_user.tagline }})</p>
    </div>
  </div>
  {% if messages %}
  {% for message in messages %}
  {% if message.tags == 'error' %}
    <div class="alert-error">
      {{ message }}
    </div>
    {% endif%}
  {% endfor %}
{% endif %}

  <div class="container">
    {% if loan.status == "pending" %}
    <h2>üü° Loan Under Review</h2>
    <div class="message">
      ‚úÖ Thank you! Your Loan & payment details have been submitted successfully.<br><br>
      ‚è≥ Please wait while We're verifying your loan request. You'll be notified soon..."
    </div>
    
    {% elif loan.status == "accepted" %}
    <h2>üü¢ Loan Confirmed</h2>
   <div class="message">
  ‚úÖ Great news! Your loan has been approved.<br><br>
  üí∏ The disbursed amount will reflect shortly in your provided account or platform.
   </div>
    {% endif %}
    <button style="margin-left: 50px;" class="toggle-btn" id="loan" onclick="toggleSection('loanDetails')">Show Loan Details</button>
    <button class="toggle-btn" id="payment" onclick="toggleSection('paymentDetails')">Show Payment Details</button>
    <button onclick="toggleContact()" class="toggle-btn" id="contact-btn">Lender Contact Details</button>
    <div class="details-section" id="loanDetails">
      
        <div class="row"><div class="label">Your Name</div><div class="value">{{ loan.borrower.name }}</div></div>
        <div class="row"><div class="label">Phone</div><div class="value">{{ loan.borrower.phone }}</div></div>
        <div class="row"><div class="label">Email</div><div class="value">{{ loan.borrower.email|default:"-" }}</div></div>
        <div class="row"><div class="label">Loan Item</div><div class="value">{{ loan.loan_item }}</div></div>
        <div class="row"><div class="label">Amount</div><div class="value" style="color: #13e948f3;">‚Çπ {{ loan.amount }}</div></div>
        <div class="row"><div class="label">Payment Plan</div><div class="value">{{ loan.payment_plan|capfirst }}</div></div>
      

        <div class="row"><div class="label">Start Date</div><div class="value">{{ loan.taken_date }}</div></div>
        <div class="row"><div class="label">End Date</div><div class="value">{{ loan.return_date }}</div></div>
        <div class="row"><div class="label">Reason</div><div class="value">{{ loan.reason|default:"-" }}</div></div>
        <div class="row"><div class="label">Referral</div><div class="value">{{ loan.referral|default:"-" }}</div></div>
        <div class="row"><div class="label">Token Id</div><div class="value">{{ loan.id }}</div></div>
       
      
        
    
    </div>

    
    <!-- Payment Details Display -->
<div class="details-section" id="paymentDetails">
  <div class="row"><div class="label">Payment Method</div><div class="value">{{ payment.payment_method|capfirst }}</div></div>

  {% if payment.payment_method == 'cash' %}
    <div class="row"><div class="label">Cash From</div><div class="value">{{ payment.cash_from }}</div></div>

  {% elif payment.payment_method == 'online' %}
    <div class="row"><div class="label">Online Platform</div><div class="value">{{ payment.online_method|capfirst }}</div></div>

    {% if payment.online_method == 'bank' %}
      <div class="row"><div class="label">Account Holder Name</div><div class="value">{{ payment.account_holder }}</div></div>
      <div class="row"><div class="label">Bank Name</div><div class="value">{{ payment.bank_name }}</div></div>
      <div class="row"><div class="label">Account Number</div><div class="value">{{ payment.account_number }}</div></div>
      <div class="row"><div class="label">IFSC Code</div><div class="value">{{ payment.ifsc }}</div></div>
    {% else %}
      <div class="row"><div class="label">Account Holder Name</div><div class="value">{{ payment.account_holder }}</div></div>
      <div class="row"><div class="label">UPI Id/Phone no. </div><div class="value">{{ payment.upi_number }}</div></div>
      {% if payment.upi_screenshot %}
        <div class="row"><div class="label">Screenshot</div><div class="value"><a href="{{ payment.upi_screenshot.url }}" target="_blank">View Payment QR code</a></div></div>
      {% endif %}
    {% endif %}
  {% endif %}
  <button class="toggle-btn" onclick="enablePaymentEdit()">Edit Payment</button>

</div>

<!-- Payment Edit Form (Initially Hidden) -->
<form id="payment-edit-form" onsubmit="return validatePaymentForm()" style="display: none; margin-top: 20px;" method="POST"  enctype="multipart/form-data">
  {% csrf_token %}
  
  <div class="row">
    <label class="label">Payment Method</label>
    <select name="payment_method" id="payment-method" onchange="handlePaymentMethod()" required>
      <option value="" disabled selected >-- Select --</option>
      <option value="cash" {% if payment.payment_method == 'cash' %}selected{% endif %}>Cash</option>
      <option value="online" {% if payment.payment_method == 'online' %}selected{% endif %}>Online</option>
    </select>
  </div>

  <div id="cash-details" style="display: none;">
    <div class="row">
      <label class="label">Cash From</label>
      <input type="text" name="cash_from" value="{{ payment.cash_from|default:'' }}">
    </div>
  </div>

  <div id="online-method" style="display: none;">
    <div class="row">
      <label class="label">Online Platform</label>
      <select name="online_method" id="online-method-select" onchange="handleOnlineMethod()">
        <option value="" disabled  selected>-- Choose --</option>
            <option value="phonepay">Phone Pay</option>
            <option value="googlepay">Google Pay</option>
            <option value="paytm">Paytm</option>
            <option value="bank">Bank Account</option>
          </select>
    </div>

    <div class="row">
      <label class="label">Account Holder Name</label>
      <input type="text" name="account_holder" value="{{ payment.account_holder|default:'' }}">
    </div>

    <div id="upi-section" style="display: none;">
      <div class="row">
        <label class="label">UPI/Phone</label>
        <input type="text" name="upi_number" value="{{ payment.upi_number|default:'' }}">
      </div>
      
    </div>

    <div id="bank-section" style="display: none;">
      <div class="row">
        <label class="label">Bank Name</label>
        <input type="text" name="bank_name" value="{{ payment.bank_name|default:'' }}">
      </div>
      <div class="row">
        <label class="label">Account Number</label>
        <input type="text" name="account_number" value="{{ payment.account_number|default:'' }}">
      </div>
      <div class="row">
        <label class="label">IFSC</label>
        <input type="text" name="ifsc" value="{{ payment.ifsc|default:'' }}">
      </div>
    </div>
  </div>

  <button class="toggle-btn" type="submit">Save</button>
  <button class="toggle-btn" type="button" onclick="cancelEdit()">Cancel</button>
</form>

<script>
  function enablePaymentEdit() {
    const form = document.getElementById('payment-edit-form');
    document.getElementById('paymentDetails').style.display = 'none';
    form.style.display = 'block';
    setTimeout(() => form.classList.add('show'), 10);  // Add animation class
    handlePaymentMethod();
  }
  
  function cancelEdit() {
    const form = document.getElementById('payment-edit-form');
    document.getElementById('paymentDetails').style.display = 'block';
    form.classList.remove('show');
    setTimeout(() => {
      form.style.display = 'none';
    }, 300);  // Wait for animation to complete
  }
  
  
  function handlePaymentMethod() {
    const method = document.getElementById('payment-method').value;
    document.getElementById('cash-details').style.display = method === 'cash' ? 'block' : 'none';
    document.getElementById('online-method').style.display = method === 'online' ? 'block' : 'none';
    if (method === 'online') {
          
    handleOnlineMethod();
    }
  }
  
  function handleOnlineMethod() {
    const method = document.getElementById('online-method-select').value;
    document.getElementById('upi-section').style.display = ["phonepay", "googlepay", "paytm"].includes(method) ? 'block' : 'none';
    document.getElementById('bank-section').style.display = method === 'bank' ? 'block' : 'none';
  }
  
</script>

       
    <div class="loan-details" id="contact-details">
      <p><span>Lender Name</span> {{ loan.lender.active_user.name }}</p>
      <p><span>Phone</span> {{ loan.lender.active_user.phone }}</p>
      <p><span>Email</span> {{ loan.lender.active_user.email }}</p>
      <p><span>Bio</span> {{ loan.lender.active_user.bio }}</p>
    </div>
  </div>

  <script>
    function toggleSection(id) {
      
      if (id==="loanDetails") {
        const contact = document.getElementById(id);
      const button = document.getElementById('loan');
      if (contact.style.display === 'none' || contact.style.display === '') {
        contact.style.display = 'block';
        button.innerText = 'Hide Loan Details';
      } else {
        contact.style.display = 'none';
        button.innerText = 'View Loan Details';
      }
      }
      else{
        const contact = document.getElementById(id);
        const button = document.getElementById('payment');
        if (contact.style.display === 'none' || contact.style.display === '') {
          contact.style.display = 'block';
          button.innerText = 'Hide Payment Details';
        } else {
          contact.style.display = 'none';
          button.innerText = 'View Payment Details';
        }

      }
    }
    function toggleContact() {
      const contact = document.getElementById('contact-details');
      const button = document.getElementById('contact-btn');
      if (contact.style.display === 'none' || contact.style.display === '') {
        contact.style.display = 'block';
        button.innerText = 'Hide Contact Details';
      } else {
        contact.style.display = 'none';
        button.innerText = 'Lender Contact Details';
      }
    }

      function validatePaymentForm() {
        const paymentMethod = document.getElementById("payment-method").value;
    
        if (!paymentMethod) {
          alert("Please select a payment method.");
          return false;
        }
    
        // Name regex: letters, spaces, 2 to 50 characters
        const nameRegex = /^[A-Za-z\s]{2,50}$/;
    
        if (paymentMethod === "cash") {
          const cashFrom = document.querySelector("input[name='cash_from']").value.trim();
          if (!cashFrom || !nameRegex.test(cashFrom)) {
            alert("Please enter a valid name for who gave the cash.");
            return false;
          }
        }
    
        else if (paymentMethod === "online") {
          const onlineMethod = document.getElementById("online-method-select").value;
          const accountHolder = document.querySelector("input[name='account_holder']").value.trim();
    
          if (!onlineMethod) {
            alert("Please choose an online payment method.");
            return false;
          }
    
          if (!accountHolder || !nameRegex.test(accountHolder)) {
            alert("Please enter a valid account holder name (only letters & spaces).");
            return false;
          }
    
          if (onlineMethod === "bank") {
            const bankName = document.querySelector("input[name='bank_name']").value.trim();
            const accountNumber = document.querySelector("input[name='account_number']").value.trim();
            const ifsc = document.querySelector("input[name='ifsc']").value.trim();
    
            const bankNameRegex = /^[A-Za-z\s]{2,100}$/;
            const accountNumberRegex = /^\d{9,18}$/;
            const ifscRegex = /^[A-Z]{4}0[A-Z0-9]{6}$/;
    
            if (!bankName || !bankNameRegex.test(bankName)) {
              alert("Please enter a valid bank name.");
              return false;
            }
    
            if (!accountNumber || !accountNumberRegex.test(accountNumber)) {
              alert("Please enter a valid account number (9-18 digits).");
              return false;
            }
    
            if (!ifsc || !ifscRegex.test(ifsc)) {
              alert("Please enter a valid IFSC code (e.g., HDFC0001234).");
              return false;
            }
          } else {
            const upi = document.querySelector("input[name='upi_number']").value.trim();

// Phone number regex (10 digits)
const phoneRegex = /^\d{10}$/;

// UPI ID regex (e.g., name@bank)
const upiRegex = /^([\w.-]+)@(\w+)$/;

if (!upi) {
  alert("Please enter a UPI ID or phone number.");
  return false;
}

if (upi.length <= 10) {
  if (!phoneRegex.test(upi)) {
    alert("Please enter a valid 10-digit phone number.");
    return false;
  }
} else {
  if (!upiRegex.test(upi)) {
    alert("Please enter a valid UPI ID (e.g., yourname@bank).");
    return false;
  }
}

          }
        }
    
        return true;
      }
    </script>
    

</body>
</html>
